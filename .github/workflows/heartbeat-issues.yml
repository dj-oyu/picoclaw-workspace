name: Heartbeat Issues Sync

on:
  push:
    paths:
      - HEARTBEAT.md
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync HEARTBEAT to Issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const core = require('@actions/core');
            const { owner, repo } = context.repo;

            const marker = 'Add your heartbeat tasks below this line:';
            const content = fs.readFileSync('HEARTBEAT.md', 'utf8');
            const idx = content.indexOf(marker);
            if (idx === -1) {
              core.setFailed(`Marker not found: ${marker}`);
              return;
            }

            const body = content.slice(idx + marker.length);
            const lines = body.split('\n');

            const tasks = [];
            for (const line of lines) {
              const trimmed = line.trim();
              if (!trimmed) continue;

              const checkboxMatch = trimmed.match(/^- \[( |x|X)\] (.+)$/);
              if (checkboxMatch) {
                const checked = checkboxMatch[1].toLowerCase() === 'x';
                const rest = checkboxMatch[2].trim();
                const issueMatch = rest.match(/^#issue:\s*(.+)$/i);
                if (!issueMatch) continue;
                const title = issueMatch[1].trim();
                if (title) tasks.push({ title, checked });
                continue;
              }

              const dashMatch = trimmed.match(/^[-*]\s+(.+)$/);
              if (dashMatch) {
                const rest = dashMatch[1].trim();
                const issueMatch = rest.match(/^#issue:\s*(.+)$/i);
                if (!issueMatch) continue;
                const title = issueMatch[1].trim();
                if (title) tasks.push({ title, checked: false });
                continue;
              }
            }

            const label = 'heartbeat';
            const existing = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, labels: label, state: 'all', per_page: 100 }
            );

            const byTitle = new Map(existing.map((i) => [i.title, i]));

            for (const task of tasks) {
              const issue = byTitle.get(task.title);
              if (!issue) {
                if (task.checked) continue; // checked tasks don't create new issues
                await github.rest.issues.create({
                  owner,
                  repo,
                  title: task.title,
                  labels: [label],
                });
                continue;
              }

              const shouldBeOpen = !task.checked;
              const isOpen = issue.state === 'open';
              if (shouldBeOpen && !isOpen) {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issue.number,
                  state: 'open',
                });
              }
              if (!shouldBeOpen && isOpen) {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issue.number,
                  state: 'closed',
                });
              }
            }
